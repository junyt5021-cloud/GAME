<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>扇形辨識挑戰 v8（頭像放大＋五列三排）</title>
  <style>
    :root{
      --bg:#FFF7F0; --card:#FFFFFF; --primary:#FFB84D; --primary-2:#FF8FB2; --accent:#71D0FF; --good:#30C48D; --bad:#FF5A5F; --ink:#2C2C2C; --muted:#7B7B7B; --shadow:0 10px 24px rgba(0,0,0,.12); --r:18px;
      --my-row:#FFE6F4;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Noto Sans,"Helvetica Neue",Arial; background:radial-gradient(1200px 600px at 80% -10%,#FFE6F1 0%,transparent 60%),radial-gradient(1200px 800px at 0% 120%,#E9FBFF 0%,transparent 60%),var(--bg); color:var(--ink);overflow-x:hidden}
    .container{max-width:1100px;margin:0 auto;padding:20px;animation:fadeIn .3s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:none;}}
    .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:22px}
    header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;}
    header .logo{font-size:28px;font-weight:800}
    .avatar-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px}
    .avatar{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border-radius:16px;border:2px solid transparent;font-size:60px;cursor:pointer;background:linear-gradient(180deg,#fff,#FFF4E0);transition:.2s transform,.2s border-color}
    .avatar:hover{transform:translateY(-2px)}.avatar.selected{border-color:#FFB84D}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 18px;border-radius:14px;background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;border:none;cursor:pointer;font-weight:700;letter-spacing:.4px;font-size:16px;box-shadow:var(--shadow);transition:opacity .2s}
    .btn.secondary{background:linear-gradient(135deg,#9EDBFF,#71D0FF)}
    .btn:hover{opacity:.9}
    .view{display:none;opacity:0;pointer-events:none;transition:opacity .3s ease-in}
    .view.active{display:block;opacity:1;pointer-events:auto}
    #gameWrap{position:relative;height:70vh;min-height:520px;overflow:hidden;border-radius:22px;background:#fff;box-shadow:var(--shadow)}
    .fall-item{position:absolute;width:160px;height:160px;background:#eee;border-radius:18px;box-shadow:0 8px 20px rgba(0,0,0,.12);overflow:hidden;display:flex;align-items:center;justify-content:center}
    .fall-item img{width:100%;height:100%;object-fit:contain;pointer-events:none}
    table{width:100%;border-collapse:collapse}th,td{padding:10px 12px;border-bottom:1px dashed #eee;text-align:left}tbody tr.me td{background:var(--my-row)}
    .hint{color:#FF8FB2;font-size:14px;margin-top:4px;}
  </style>
</head>
<body>
  <header>
    <div class="logo">🍰 扇形辨識挑戰</div>
    <button id="btnMusic" class="btn secondary">🔈 音樂開關</button>
  </header>
  <div class="container">
    <!-- 登入頁 -->
    <section id="view-login" class="view active">
      <div class="card">
        <h2>👶 登入遊戲</h2>
        <p style="color:#FF8FB2;font-size:15px;margin-top:-6px">請選擇你的頭像與姓名，一起挑戰扇形小遊戲吧！</p>
        <input id="name" type="text" placeholder="姓名" style="padding:10px;margin:5px;width:200px"> 
        <input id="seat" type="number" placeholder="座號" style="padding:10px;margin:5px;width:200px">
        <div id="avatars" class="avatar-grid"></div>
        <button id="btnStart" class="btn">開始遊戲 🚀</button>
      </div>
    </section>

    <!-- 遊戲頁 -->
    <section id="view-game" class="view">
      <div class="card">
        <div id="hud" style="margin-bottom:8px">👤 <span id="hudName"></span> | 分數：<span id="hudScore">0</span> | Combo：<span id="hudCombo">0</span> | 倒數：<span id="hudTime">60</span>s</div>
        <div id="gameWrap"></div>
      </div>
    </section>

    <!-- 結果與排行榜頁 -->
    <section id="view-end" class="view">
      <div class="card">
        <h2>🎉 本局結果</h2>
        <div>分數：<span id="finalScore">0</span></div>
        <div>最高連擊：<span id="finalCombo">0</span></div>
        <p id="resultBadge"></p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button id="btnReplay" class="btn">再玩一次</button>
          <button id="btnBack" class="btn secondary">回登入頁</button>
        </div>
      </div>
      <div class="card" style="margin-top:14px">
        <h2>🏆 全班即時排行榜（前20名）</h2>
        <p class="hint">💡 每位學生僅保留最高分紀錄喔！</p>
        <table><thead><tr><th>名次</th><th>姓名</th><th>座號</th><th>分數</th><th>最高Combo</th><th>時間</th></tr></thead><tbody id="boardBody"></tbody></table>
      </div>
    </section>
  </div>

  <audio id="bgm" src="背景音效.mp3" loop></audio>

  <script type="module">
    // 初始化
    localStorage.removeItem('sectors_local');
    const avatarSet=['🐻','🐰','🐼','🐱','🐸','🦊','🐨','🐯','🐹','🐵','🦄','🐧','🐥','🐙','🐞'];
    const avatarBox=document.getElementById('avatars');
    const state={player:{name:'',seat:'',avatar:avatarSet[0]},playing:false,tLeft:60,score:0,combo:0,bestCombo:0,timer:null,spawn:null};

    // 生成頭像
    avatarSet.forEach((av,i)=>{const b=document.createElement('button');b.className='avatar';b.textContent=av;if(i===0)b.classList.add('selected');b.onclick=()=>{document.querySelectorAll('.avatar').forEach(a=>a.classList.remove('selected'));b.classList.add('selected');state.player.avatar=av;tryPlayBgm();};avatarBox.appendChild(b);});

    const viewLogin=document.getElementById('view-login');const viewGame=document.getElementById('view-game');const viewEnd=document.getElementById('view-end');
    const gameWrap=document.getElementById('gameWrap');const hudName=document.getElementById('hudName');const hudScore=document.getElementById('hudScore');const hudCombo=document.getElementById('hudCombo');const hudTime=document.getElementById('hudTime');
    const finalScore=document.getElementById('finalScore');const finalCombo=document.getElementById('finalCombo');const resultBadge=document.getElementById('resultBadge');const boardBody=document.getElementById('boardBody');

    const bgm=document.getElementById('bgm');const btnMusic=document.getElementById('btnMusic');let bgmReady=false;
    async function tryPlayBgm(){try{await bgm.play();bgmReady=true;}catch(e){}}
    window.addEventListener('load',tryPlayBgm);
    btnMusic.onclick=()=>{bgm.muted=!bgm.muted;btnMusic.textContent=bgm.muted?'🔇 已靜音':'🔈 音樂開關';if(!bgmReady)tryPlayBgm();};

    const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    function playCorrect(){const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type='sine';o.frequency.value=880;g.gain.setValueAtTime(0.001,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.01);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.25);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.26);}
    function playWrong(){const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type='square';o.frequency.value=220;g.gain.setValueAtTime(0.001,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.25,audioCtx.currentTime+0.02);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.4);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.42);}

    document.getElementById('btnStart').onclick=()=>{const n=document.getElementById('name').value.trim();const s=document.getElementById('seat').value.trim();if(!n||!s){alert('請輸入姓名與座號');return;}state.player.name=n;state.player.seat=s;hudName.textContent=`${state.player.avatar} ${n} #${s}`;startGame();tryPlayBgm();};
    document.getElementById('btnBack').onclick=()=>show(viewLogin);
    document.getElementById('btnReplay').onclick=()=>{show(viewGame);startGame();tryPlayBgm();};

    function show(v){[viewLogin,viewGame,viewEnd].forEach(e=>{e.classList.remove('active');});setTimeout(()=>{v.classList.add('active');},50);}

    const images=[{src:'投影片1.JPG',isSector:true},{src:'投影片2.JPG',isSector:true},{src:'投影片3.JPG',isSector:true},{src:'投影片4.JPG',isSector:true},{src:'投影片5.JPG',isSector:true},{src:'投影片6.JPG',isSector:true},{src:'投影片7.JPG',isSector:false},{src:'投影片8.JPG',isSector:false},{src:'投影片9.JPG',isSector:false},{src:'投影片10.JPG',isSector:false}];

    function startGame(){state.playing=true;state.tLeft=60;state.score=0;state.combo=0;state.bestCombo=0;hudScore.textContent='0';hudCombo.textContent='0';hudTime.textContent='60';gameWrap.innerHTML='';show(viewGame);state.timer=setInterval(()=>{state.tLeft--;hudTime.textContent=state.tLeft;if(state.tLeft<=0)endGame(true);},1000);state.spawn=setInterval(spawn,650);}
    function endGame(timeUp){if(!state.playing)return;state.playing=false;clearInterval(state.timer);clearInterval(state.spawn);const record={name:state.player.name,seat:state.player.seat,avatar:state.player.avatar,score:state.score,bestCombo:state.bestCombo,createdAt:Date.now()};
      let rows=JSON.parse(localStorage.getItem('sectors_local')||'[]');
      const idx=rows.findIndex(r=>r.name===record.name&&r.seat===record.seat);
      if(idx>-1){ if(record.score>rows[idx].score) rows[idx]=record; } else { rows.push(record); }
      localStorage.setItem('sectors_local',JSON.stringify(rows));
      finalScore.textContent=state.score;finalCombo.textContent=state.bestCombo;resultBadge.textContent=timeUp?'⏳ 挑戰成功':'💥 點錯了';show(viewEnd);loadLeaderboard();}

    function spawn(){if(!state.playing)return;const it=images[Math.floor(Math.random()*images.length)];const el=document.createElement('div');el.className='fall-item';const img=document.createElement('img');img.src=it.src;el.appendChild(img);el.style.left=Math.random()*(gameWrap.clientWidth-160)+'px';el.style.top='-180px';el.onclick=(e)=>{e.stopPropagation();if(!state.playing)return;if(it.isSector){playCorrect();state.combo++;state.bestCombo=Math.max(state.combo,state.bestCombo);state.score+=10*state.combo;hudScore.textContent=state.score;hudCombo.textContent=state.combo;el.remove();}else{playWrong();endGame(false);}};gameWrap.appendChild(el);let y=-180;const fall=()=>{if(!state.playing){el.remove();return;}y+=2.4;el.style.top=y+'px';if(y>gameWrap.clientHeight){state.combo=0;hudCombo.textContent=0;el.remove();return;}requestAnimationFrame(fall);};requestAnimationFrame(fall);}

    function loadLeaderboard(){const rows=JSON.parse(localStorage.getItem('sectors_local')||'[]');rows.sort((a,b)=>b.score-a.score||a.createdAt-b.createdAt);const isMe=r=>r.name===state.player.name&&r.seat===state.player.seat;boardBody.innerHTML=rows.slice(0,20).map((r,i)=>{const dt=new Date(r.createdAt);const t=dt.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'});const c=isMe(r)?' class="me"':'';return `<tr${c}><td>${i+1}</td><td>${r.avatar||'👤'} ${r.name}</td><td>#${r.seat}</td><td>${r.score}</td><td>${r.bestCombo}</td><td>${t}</td></tr>`;}).join('');}

    show(viewLogin);
  </script>
</body>
</html>